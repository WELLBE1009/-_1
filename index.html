<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>複数店舗売上比較ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <style>
        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background-color: #f0f4f8;
        }
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .chart-container-large {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .store-metric-card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1rem;
            text-align: center;
        }
        .store-metric-card h4 {
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 0.5rem;
        }
        .store-metric-card p {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
        }
        textarea {
            resize: none;
        }
        #shareModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-4 md:p-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">複数店舗売上比較ダッシュボード</h1>
                <p class="text-gray-600 mt-2">日別データから自動生成されたインタラクティブな分析ツール</p>
            </div>
            <div id="dataInputSection">
                <button id="shareBtn" class="btn-primary px-4 py-2 rounded-md">分析結果を共有</button>
            </div>
        </header>

        <div class="mb-8" id="inputSection">
            <div class="card p-4 md:p-6">
                <h2 class="text-xl font-semibold mb-4">データを入力</h2>
                <p class="text-gray-600 mb-4">以下のテキストエリアにデータを貼り付けてください。<br>
                必要な列: 対象日, 曜日, 売上日計, サウナ, 人数（S), 宿泊売上計, 人数(C), マッサージ, グリ, 物販</p>
                
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="flex-1">
                        <label for="eitenDataInput" class="block text-sm font-medium text-gray-700 mb-1">栄店データ</label>
                        <textarea id="eitenDataInput" rows="6" class="w-full p-2 border border-gray-300 rounded-md" placeholder="栄店のデータをここに貼り付けてください（CSVまたはタブ区切り形式）"></textarea>
                    </div>
                    <div class="flex-1">
                        <label for="imaikeDataInput" class="block text-sm font-medium text-gray-700 mb-1">今池店データ</label>
                        <textarea id="imaikeDataInput" rows="6" class="w-full p-2 border border-gray-300 rounded-md" placeholder="今池店のデータをここに貼り付けてください（CSVまたはタブ区切り形式）"></textarea>
                    </div>
                    <div class="flex-1">
                        <label for="fukuokaDataInput" class="block text-sm font-medium text-gray-700 mb-1">福岡店データ</label>
                        <textarea id="fukuokaDataInput" rows="6" class="w-full p-2 border border-gray-300 rounded-md" placeholder="福岡店のデータをここに貼り付けてください（CSVまたはタブ区切り形式）"></textarea>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row gap-4">
                    <button id="processDataBtn" class="btn-primary px-4 py-2 rounded-md">データを分析</button>
                    <button id="loadSampleBtn" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-md">サンプルデータを読み込む</button>
                </div>
                
                <div id="fileStatus" class="mt-4 hidden">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700" id="fileStatusText">
                                    データを処理中...
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboardContent" class="hidden">
            <div class="card p-4 md:p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">期間フィルター</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">期間</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="date" id="startDate" class="flex-1 p-2 border border-gray-300 rounded-md">
                            <span class="flex items-center justify-center">～</span>
                            <input type="date" id="endDate" class="flex-1 p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">曜日</label>
                        <select id="weekdayFilter" class="w-1/2 p-2 border border-gray-300 rounded-md">
                            <option value="all">すべて</option>
                            <option value="月">月曜日</option>
                            <option value="火">火曜日</option>
                            <option value="水">水曜日</option>
                            <option value="木">木曜日</option>
                            <option value="金">金曜日</option>
                            <option value="土">土曜日</option>
                            <option value="日">日曜日</option>
                        </select>
                    </div>
                    <div class="flex items-end md:col-span-2">
                        <button id="applyFilterBtn" class="btn-primary px-4 py-2 rounded-md w-full">フィルターを適用</button>
                    </div>
                </div>
            </div>

            <div class="card p-4 md:p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">店舗別主要指標</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="storeSpecificMetrics">
                    </div>
            </div>

            <div class="card p-4 md:p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">日別売上推移</h2>
                <div class="chart-container-large">
                    <canvas id="dailySalesChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="card p-4 md:p-6">
                    <h2 class="text-xl font-semibold mb-4">サービス別売上構成 (店舗別)</h2>
                    <div class="chart-container">
                        <canvas id="serviceSalesChart"></canvas>
                    </div>
                </div>
                <div class="card p-4 md:p-6">
                    <h2 class="text-xl font-semibold mb-4">店舗別総売上比較</h2>
                    <div class="chart-container">
                        <canvas id="storeSalesComparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card p-4 md:p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">店舗別利用者数比較</h2>
                <div class="chart-container-large">
                    <canvas id="storeUserCountComparisonChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="shareModal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">分析結果を共有</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p class="mb-4">以下のURLを共有すると、現在の分析結果を他の人と共有できます。</p>
            <div class="flex mb-4">
                <input id="shareUrl" type="text" class="flex-1 p-2 border border-gray-300 rounded-l-md" readonly>
                <button id="copyUrlBtn" class="btn-primary px-4 py-2 rounded-r-md">コピー</button>
            </div>
            <div class="mt-4 text-sm text-gray-600">
                <p>※ 共有URLには入力データが含まれています。共有先でデータの入力は不要です。</p>
                <p>※ 長期間の保存には適していません。データ量が多い場合はURLが長くなります。</p>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数として定義
        const fixedStores = ['栄店', '今池店', '福岡店'];

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOMContentLoaded fired. Script execution starting within listener.");

            // グローバル変数
            let salesData = [];
            let filteredData = [];
            let charts = {};
            let isViewMode = false;
            
            // 曜日の順序マッピング（ソート用）
            const weekdayOrder = {
                '月': 0,
                '火': 1,
                '水': 2,
                '木': 3,
                '金': 4,
                '土': 5,
                '日': 6
            };

            // Chart.js の色パレット（複数の店舗に対応するため）
            const chartColors = [
                'rgba(59, 130, 246, 1)',    // Blue
                'rgba(16, 185, 129, 1)',    // Green
                'rgba(245, 158, 11, 1)',    // Amber
                'rgba(139, 92, 246, 1)',    // Purple
                'rgba(236, 72, 153, 1)',    // Pink
                'rgba(220, 38, 38, 1)',     // Red
                'rgba(107, 114, 128, 1)'    // Gray
            ];
            const chartBackgroundColors = [
                'rgba(59, 130, 246, 0.2)',
                'rgba(16, 185, 129, 0.2)',
                'rgba(245, 158, 11, 0.2)',
                'rgba(139, 92, 246, 0.2)',
                'rgba(236, 72, 153, 0.2)',
                'rgba(220, 38, 38, 0.2)',
                'rgba(107, 114, 128, 0.2)'
            ];

            // --- 関数定義をDOMContentLoaded内へ移動 (呼び出し順序を考慮) ---

            // 日付文字列を標準形式（YYYY-MM-DD）に変換する関数
            function parseAndFormatDate(dateStr) {
                if (!dateStr) return null;
                
                // 日付文字列を正規化（区切り文字を統一）
                dateStr = String(dateStr).trim()
                    .replace(/[年月]/g, '/')
                    .replace(/日/g, '')
                    .replace(/\s+/g, '');
                
                let parsedDate;
                
                // YYYY/MM/DD または YYYY-MM-DD 形式
                if (/^\d{4}[/-]\d{1,2}[/-]\d{1,2}$/.test(dateStr)) {
                    const parts = dateStr.split(/[/-]/);
                    parsedDate = new Date(parts[0], parts[1] - 1, parts[2]);
                }
                // MM/DD/YYYY 形式
                else if (/^\d{1,2}[/-]\d{1,2}[/-]\d{4}$/.test(dateStr)) {
                    const parts = dateStr.split(/[/-]/);
                    parsedDate = new Date(parts[2], parts[0] - 1, parts[1]);
                }
                // DD/MM/YYYY 形式（日本では少ないが一応）
                else if (/^\d{1,2}[/-]\d{1,2}[/-]\d{4}$/.test(dateStr)) {
                    const parts = dateStr.split(/[/-]/);
                    parsedDate = new Date(parts[2], parts[1] - 1, parts[0]);
                }
                // YYYYMMDD 形式
                else if (/^\d{8}$/.test(dateStr)) {
                    const year = dateStr.substring(0, 4);
                    const month = dateStr.substring(4, 6);
                    const day = dateStr.substring(6, 8);
                    parsedDate = new Date(year, month - 1, day);
                }
                // その他の形式は直接 Date コンストラクタで試す
                else {
                    parsedDate = new Date(dateStr);
                }
                
                // 日付が有効かチェック
                if (isNaN(parsedDate.getTime())) {
                    console.warn(`無効な日付形式: ${dateStr}`);
                    return null;
                }
                
                // YYYY-MM-DD 形式に変換
                const year = parsedDate.getFullYear();
                const month = String(parsedDate.getMonth() + 1).padStart(2, '0');
                const day = String(parsedDate.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            }

            // 日付範囲の設定
            function setupDateRange() {
                const dates = salesData.map(item => new Date(item.date));
                const validDates = dates.filter(date => !isNaN(date.getTime()));
                
                if (validDates.length > 0) {
                    const minDate = new Date(Math.min(...validDates));
                    const maxDate = new Date(Math.max(...validDates));
                    
                    document.getElementById('startDate').value = minDate.toISOString().split('T')[0];
                    document.getElementById('endDate').value = maxDate.toISOString().split('T')[0];
                }
            }

            // URLパラメータのチェック
            function checkUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const viewMode = urlParams.get('view');
                const startDate = urlParams.get('start');
                const endDate = urlParams.get('end');
                const weekday = urlParams.get('weekday');
                const compressedData = urlParams.get('data');
                
                if (viewMode === 'true') {
                    isViewMode = true;
                    // 入力セクションを非表示
                    document.getElementById('inputSection').style.display = 'none';
                    
                    // フィルター設定を復元
                    if (startDate) document.getElementById('startDate').value = startDate;
                    if (endDate) document.getElementById('endDate').value = endDate;
                    if (weekday) document.getElementById('weekdayFilter').value = weekday;
                    
                    // 共有ボタンのテキストを変更
                    document.getElementById('shareBtn').textContent = 'データを編集';
                    document.getElementById('shareBtn').addEventListener('click', function() {
                        window.location.href = window.location.pathname;
                    });
                    
                    // 圧縮データがある場合は復元
                    if (compressedData) {
                        try {
                            const decompressedData = LZString.decompressFromEncodedURIComponent(compressedData);
                            if (decompressedData) {
                                const parsedData = JSON.parse(decompressedData);
                                if (Array.isArray(parsedData) && parsedData.length > 0) {
                                    salesData = parsedData;
                                    setupDateRange();
                                    applyFilters();
                                    document.getElementById('dashboardContent').classList.remove('hidden');
                                }
                            }
                        } catch (e) {
                            console.error('データの復元に失敗しました:', e);
                            alert('共有データの読み込みに失敗しました。URLが正しいか確認してください。');
                        }
                    }
                }
            }

            // 単一店舗のデータを処理するヘルパー関数
            function processSingleStoreData(data, storeName) {
                return data.map(row => {
                    try {
                        let dateValue = row['対象日'] || row['日付'] || Object.values(row)[0];
                        const formattedDate = parseAndFormatDate(dateValue);
                        
                        if (!formattedDate) {
                            console.error("日付の解析に失敗:", dateValue);
                            return null;
                        }

                        const parseNumeric = (value) => {
                            if (value === undefined || value === null || value === '') return 0;
                            if (typeof value === 'number') return value;
                            return Number(String(value).replace(/[^\d.-]/g, '')) || 0;
                        };

                        const weekday = row['曜日'] || '';
                        const totalSales = parseNumeric(row['売上日計'] || row['売上合計'] || row['総売上']);
                        const saunaSales = parseNumeric(row['サウナ'] || row['サウナ売上']);
                        
                        let saunaCount = 0;
                        for (const key of Object.keys(row)) {
                            if (key.includes('人数') && (key.includes('S') || key.includes('s') || key.toLowerCase().includes('sauna'))) {
                                saunaCount = parseNumeric(row[key]);
                                break;
                            }
                        }
                        if (saunaCount === 0) {
                            saunaCount = parseNumeric(row['サウナ人数'] || row['サウナ利用者数']);
                        }
                        
                        const stayingSales = parseNumeric(row['宿泊売上計'] || row['宿泊売上'] || row['宿泊']);
                        
                        let stayingCount = 0;
                        for (const key of Object.keys(row)) {
                            if (key.includes('人数') && (key.includes('C') || key.includes('c') || key.toLowerCase().includes('stay'))) {
                                stayingCount = parseNumeric(row[key]);
                                break;
                            }
                        }
                        if (stayingCount === 0) {
                            stayingCount = parseNumeric(row['宿泊人数'] || row['宿泊者数']);
                        }
                        
                        const massageSales = parseNumeric(row['マッサージ'] || row['マッサージ売上']);
                        const grillSales = parseNumeric(row['グリ'] || row['グリル'] || row['グリル売上']);
                        const retailSales = parseNumeric(row['物販'] || row['物販売上']);

                        return {
                            date: formattedDate,
                            weekday: weekday,
                            storeName: storeName, // ここで店舗名を割り当て
                            totalSales: totalSales,
                            saunaSales: saunaSales,
                            saunaCount: saunaCount,
                            stayingSales: stayingSales,
                            stayingCount: stayingCount,
                            massageSales: massageSales,
                            grillSales: grillSales,
                            retailSales: retailSales
                        };
                    } catch (e) {
                        console.error("行の処理中にエラー:", e);
                        return null;
                    }
                }).filter(item => item && item.date);
            }

            // サンプルデータをテキストエリア表示用にフォーマット
            function formatSampleDataForDisplay(data) {
                if (!data || data.length === 0) return '';
                
                // ヘッダー行 (店舗名は含めない)
                const headers = ['対象日', '曜日', '売上日計', 'サウナ', '人数（S)', '宿泊売上計', '人数(C)', 'マッサージ', 'グリ', '物販'];
                
                // データ行
                const rows = data.map(item => {
                    // 日付を YYYY-MM-DD から YYYY/MM/DD に変換
                    const formattedDate = item.date.replace(/-/g, '/');
                    
                    return [
                        formattedDate,
                        item.weekday,
                        item.totalSales,
                        item.saunaSales,
                        item.saunaCount,
                        item.stayingSales,
                        item.stayingCount,
                        item.massageSales,
                        item.grillSales,
                        item.retailSales
                    ];
                });
                
                // タブ区切りで結合
                return [headers.join('\t')].concat(rows.map(row => row.join('\t'))).join('\n');
            }

            // サンプルデータの生成
            function generateSampleData() {
                const data = [];
                const weekdays = ['月', '火', '水', '木', '金', '土', '日'];
                const stores = fixedStores; // 固定店舗を使用
                
                // 過去3ヶ月分のデータを生成
                const endDate = new Date();
                const startDate = new Date();
                startDate.setMonth(endDate.getMonth() - 3);
                
                // 基本料金設定
                const baseSettings = {
                    saunaPrice: 1500,
                    stayingPrice: 6000,
                    massagePrice: 4000,
                    grillAvg: 1200,
                    retailAvg: 800
                };
                
                // 曜日係数（土日は混む）
                const weekdayFactor = {
                    '月': 0.7,
                    '火': 0.6,
                    '水': 0.7,
                    '木': 0.8,
                    '金': 1.0,
                    '土': 1.5,
                    '日': 1.3
                };

                // 店舗ごとの売上特性をシミュレート
                const storeFactors = {
                    '栄店': { total: 1.0, sauna: 1.0, staying: 1.0, massage: 1.0, grill: 1.0, retail: 1.0 },
                    '今池店': { total: 0.9, sauna: 1.1, staying: 0.8, massage: 1.2, grill: 0.9, retail: 0.7 },
                    '福岡店': { total: 1.1, sauna: 0.9, staying: 1.2, massage: 0.8, grill: 1.1, retail: 1.3 }
                };

                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const weekday = weekdays[d.getDay() === 0 ? 6 : d.getDay() - 1]; // 0=日曜 を 6=日曜 に変換
                    const factor = weekdayFactor[weekday];
                    
                    // 季節係数（月によって変動）
                    const monthFactor = 1 + (Math.sin(d.getMonth() / 2) * 0.2);
                    
                    for (const storeName of stores) {
                        // ランダム係数（日によるばらつき）
                        const randomFactor = 0.8 + (Math.random() * 0.4);
                        
                        // 総合係数
                        const totalFactor = factor * monthFactor * randomFactor * storeFactors[storeName].total;
                        
                        // サウナ利用者数
                        const saunaCount = Math.round(40 * totalFactor * storeFactors[storeName].sauna);
                        
                        // 宿泊者数（サウナ利用者の一部）
                        const stayingCount = Math.round(saunaCount * 0.15 * storeFactors[storeName].staying);
                        
                        // 各売上の計算
                        const saunaSales = saunaCount * baseSettings.saunaPrice;
                        const stayingSales = stayingCount * baseSettings.stayingPrice;
                        const massageSales = Math.round(saunaCount * 0.2 * storeFactors[storeName].massage) * baseSettings.massagePrice;
                        const grillSales = Math.round(saunaCount * 0.6 * storeFactors[storeName].grill) * baseSettings.grillAvg;
                        const retailSales = Math.round(saunaCount * 0.3 * storeFactors[storeName].retail) * baseSettings.retailAvg;
                        
                        // 総売上
                        const totalSales = saunaSales + stayingSales + massageSales + grillSales + retailSales;
                        
                        data.push({
                            date: d.toISOString().split('T')[0],
                            weekday: weekday,
                            storeName: storeName, // 店舗名を追加
                            totalSales: Math.round(totalSales),
                            saunaSales: Math.round(saunaSales),
                            saunaCount: saunaCount,
                            stayingSales: Math.round(stayingSales),
                            stayingCount: stayingCount,
                            massageSales: Math.round(massageSales),
                            grillSales: Math.round(grillSales),
                            retailSales: Math.round(retailSales)
                        });
                    }
                }

                // 将来の日付を追加（2025/5/1）
                stores.forEach(storeName => {
                    data.push({
                        date: "2025-05-01",
                        weekday: "木",
                        storeName: storeName,
                        totalSales: 350000 * storeFactors[storeName].total,
                        saunaSales: 120000 * storeFactors[storeName].sauna,
                        saunaCount: 80 * storeFactors[storeName].sauna,
                        stayingSales: 150000 * storeFactors[storeName].staying,
                        stayingCount: 25 * storeFactors[storeName].staying,
                        massageSales: 40000 * storeFactors[storeName].massage,
                        grillSales: 25000 * storeFactors[storeName].grill,
                        retailSales: 15000 * storeFactors[storeName].retail
                    });
                });

                return data;
            }

            // 入力データの処理
            function processInputData() {
                const storeTextareas = {
                    '栄店': document.getElementById('eitenDataInput').value.trim(),
                    '今池店': document.getElementById('imaikeDataInput').value.trim(),
                    '福岡店': document.getElementById('fukuokaDataInput').value.trim()
                };

                salesData = []; // 既存のデータをクリア

                const fileStatus = document.getElementById('fileStatus');
                const fileStatusText = document.getElementById('fileStatusText');
                
                fileStatus.classList.remove('hidden');
                fileStatusText.textContent = `データを処理中...`;

                let hasValidData = false;

                for (const storeName of fixedStores) {
                    const inputText = storeTextareas[storeName];
                    if (!inputText) {
                        console.warn(`${storeName} のデータが入力されていません。`);
                        continue;
                    }

                    try {
                        const delimiter = inputText.includes('\t') ? '\t' : ',';
                        const lines = inputText.split(/\r?\n/).filter(line => line.trim());
                        
                        if (lines.length <= 1) { // ヘッダー行のみ、またはデータなし
                            console.warn(`${storeName} のデータが不足しています。`);
                            continue;
                        }

                        const headers = lines[0].split(delimiter).map(h => h.trim());
                        
                        const storeSpecificData = [];
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(delimiter);
                            if (values.length !== headers.length) continue;
                            
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index].trim();
                            });
                            storeSpecificData.push(row);
                        }
                        
                        // 各行に店舗名を追加して処理
                        const processedStoreData = processSingleStoreData(storeSpecificData, storeName);
                        salesData = salesData.concat(processedStoreData);
                        if (processedStoreData.length > 0) {
                            hasValidData = true;
                        }

                    } catch (error) {
                        console.error(`${storeName} のデータ処理エラー:`, error);
                        fileStatusText.textContent = `エラー: ${storeName} のデータ処理中にエラーが発生しました: ${error.message}`;
                        return;
                    }
                }

                if (!hasValidData) {
                    document.getElementById('fileStatusText').textContent = "有効なデータが見つかりませんでした。データ形式を確認してください。";
                    return;
                }

                // 全データを日付でソート
                salesData.sort((a, b) => a.date.localeCompare(b.date));
                
                setupDateRange();
                applyFilters();
                
                document.getElementById('dashboardContent').classList.remove('hidden');
                fileStatusText.textContent = `${salesData.length}件のデータを読み込みました。`;
            }

            // サンプルデータの読み込み
            function loadSampleData() {
                console.log("loadSampleData called.");
                const fileStatus = document.getElementById('fileStatus');
                const fileStatusText = document.getElementById('fileStatusText');
                
                fileStatus.classList.remove('hidden');
                fileStatusText.textContent = "サンプルデータを読み込み中...";

                // サンプルデータの生成
                const sampleData = generateSampleData();
                
                // 各店舗のサンプルデータをそれぞれのテキストエリアに表示
                const eitenSample = formatSampleDataForDisplay(sampleData.filter(d => d.storeName === '栄店'));
                const imaikeSample = formatSampleDataForDisplay(sampleData.filter(d => d.storeName === '今池店'));
                const fukuokaSample = formatSampleDataForDisplay(sampleData.filter(d => d.storeName === '福岡店'));

                document.getElementById('eitenDataInput').value = eitenSample;
                document.getElementById('imaikeDataInput').value = imaikeSample;
                document.getElementById('fukuokaDataInput').value = fukuokaSample;
                
                // サンプルデータは既に構造化されているので、直接処理
                salesData = sampleData;
                console.log("Calling setupDateRange from loadSampleData.");
                setupDateRange();
                applyFilters();
                
                // ダッシュボードを表示
                document.getElementById('dashboardContent').classList.remove('hidden');
                fileStatusText.textContent = `${salesData.length}件のサンプルデータを読み込みました。`;
            }

            // フィルターの適用
            function applyFilters() {
                const startDateStr = document.getElementById('startDate').value;
                const endDateStr = document.getElementById('endDate').value;
                const weekday = document.getElementById('weekdayFilter').value;
                
                filteredData = salesData.filter(item => {
                    const dateCondition = (!startDateStr || item.date >= startDateStr) && (!endDateStr || item.date <= endDateStr);
                    const weekdayCondition = weekday === 'all' || item.weekday === weekday;
                    const storeCondition = fixedStores.includes(item.storeName); // 固定店舗のみをフィルタリング
                    
                    return dateCondition && weekdayCondition && storeCondition;
                });
                
                // ダッシュボードの更新
                updateDashboard();
            }

            // ダッシュボードの更新
            function updateDashboard() {
                updateStoreSpecificMetrics(); // 新しい店舗別主要指標の更新
                updateCharts();
            }

            // 店舗別主要指標の更新
            function updateStoreSpecificMetrics() {
                const container = document.getElementById('storeSpecificMetrics');
                container.innerHTML = ''; // 既存のコンテンツをクリア

                const storeColors = {
                    '栄店': {
                        bg: 'bg-blue-50',
                        heading: 'text-blue-800'
                    },
                    '今池店': {
                        bg: 'bg-green-50',
                        heading: 'text-green-800'
                    },
                    '福岡店': {
                        bg: 'bg-purple-50',
                        heading: 'text-purple-800'
                    }
                };

                fixedStores.forEach(storeName => {
                    const storeData = filteredData.filter(item => item.storeName === storeName);

                    const totalSales = storeData.reduce((sum, item) => sum + item.totalSales, 0);
                    const totalSaunaCount = storeData.reduce((sum, item) => sum + item.saunaCount, 0);
                    const totalStayingCount = storeData.reduce((sum, item) => sum + item.stayingCount, 0);
                    const totalUsers = totalSaunaCount + totalStayingCount;
                    const averagePrice = totalUsers > 0 ? totalSales / totalUsers : 0;

                    const saunaSales = storeData.reduce((sum, item) => sum + item.saunaSales, 0);
                    const stayingSales = storeData.reduce((sum, item) => sum + item.stayingSales, 0);
                    const massageSales = storeData.reduce((sum, item) => sum + item.massageSales, 0);
                    const grillSales = storeData.reduce((sum, item) => sum + item.grillSales, 0);
                    const retailSales = storeData.reduce((sum, item) => sum + item.retailSales, 0);

                    const color = storeColors[storeName] || { bg: 'bg-white', heading: 'text-gray-800' };

                    const card = document.createElement('div');
                    card.className = `store-metric-card ${color.bg}`;

                    card.innerHTML = `
                        <h3 class="text-xl font-bold mb-2 ${color.heading}">${storeName}</h3>
                        <div class="grid grid-cols-2 gap-2 text-left text-sm">
                            <div><span class="font-medium text-gray-600">総売上:</span><p class="text-lg font-semibold text-blue-700">¥${totalSales.toLocaleString()}</p></div>
                            <div><span class="font-medium text-gray-600">サウナ利用者数:</span><p class="text-lg font-semibold text-green-700">${totalSaunaCount.toLocaleString()}人</p></div>
                            <div><span class="font-medium text-gray-600">宿泊者数:</span><p class="text-lg font-semibold text-purple-700">${totalStayingCount.toLocaleString()}人</p></div>
                            <div><span class="font-medium text-gray-600">平均客単価:</span><p class="text-lg font-semibold text-yellow-700">¥${Math.round(averagePrice).toLocaleString()}</p></div>
                            <div><span class="font-medium text-gray-600">サウナ売上:</span><p>¥${saunaSales.toLocaleString()}</p></div>
                            <div><span class="font-medium text-gray-600">宿泊売上:</span><p>¥${stayingSales.toLocaleString()}</p></div>
                            <div><span class="font-medium text-gray-600">マッサージ売上:</span><p>¥${massageSales.toLocaleString()}</p></div>
                            <div><span class="font-medium text-gray-600">グリル売上:</span><p>¥${grillSales.toLocaleString()}</p></div>
                            <div><span class="font-medium text-gray-600">物販売上:</span><p>¥${retailSales.toLocaleString()}</p></div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            // チャートの更新
            function updateCharts() {
                // 既存のチャートを破棄
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                charts = {};
                
                // 日別売上推移チャート
                createDailySalesChart();
                
                // サービス別売上構成チャート
                createServiceSalesChart();

                // 店舗別売上比較チャート
                createStoreSalesComparisonChart();

                // 店舗別利用者数比較チャート
                createStoreUserCountComparisonChart();
            }

            // 日別売上推移チャートの作成
            function createDailySalesChart() {
                const ctx = document.getElementById('dailySalesChart').getContext('2d');
                
                // ユニークな日付（YYYY-MM-DD形式）のラベルをそのまま使う
                const uniqueDates = [...new Set(filteredData.map(item => item.date))].sort();
                const labels = uniqueDates;

                const datasets = [];
                fixedStores.forEach((store, index) => {
                    const storeData = filteredData.filter(item => item.storeName === store);
                    
                    const storeSalesData = labels.map(targetDate => {
                        const dailyItem = storeData.find(item => item.date === targetDate);
                        return dailyItem ? dailyItem.totalSales : 0;
                    });

                    datasets.push({
                        label: `${store} 総売上`,
                        data: storeSalesData,
                        backgroundColor: chartBackgroundColors[index % chartBackgroundColors.length],
                        borderColor: chartColors[index % chartColors.length],
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false
                    });
                });
                
                charts.dailySales = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ¥${context.raw.toLocaleString()}`;
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        callback: function(label) {
                                            const date = new Date(label);
                                            return `${date.getMonth() + 1}/${date.getDate()}`;
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: '日付'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '売上 (円)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '¥' + value.toLocaleString();
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // サービス別売上構成チャートの作成 (店舗別グループ化棒グラフ)
            function createServiceSalesChart() {
                const ctx = document.getElementById('serviceSalesChart').getContext('2d');
                
                const serviceTypes = ['saunaSales', 'stayingSales', 'massageSales', 'grillSales', 'retailSales'];
                const serviceLabels = ['サウナ', '宿泊', 'マッサージ', 'グリル', '物販'];

                const datasets = [];
                
                // 各店舗のサービス別合計を計算
                const storeServiceTotals = {};
                fixedStores.forEach(storeName => {
                    storeServiceTotals[storeName] = {};
                    serviceTypes.forEach(serviceType => {
                        storeServiceTotals[storeName][serviceType] = filteredData
                            .filter(item => item.storeName === storeName)
                            .reduce((sum, item) => sum + item[serviceType], 0);
                    });
                });

                // データセットを作成 (サービスタイプごとに店舗のデータをグループ化)
                fixedStores.forEach((storeName, storeIndex) => {
                    const dataForStore = serviceTypes.map(serviceType => storeServiceTotals[storeName][serviceType]);
                    datasets.push({
                        label: storeName,
                        data: dataForStore,
                        backgroundColor: chartColors[storeIndex % chartColors.length],
                        borderColor: chartColors[storeIndex % chartColors.length],
                        borderWidth: 1,
                        barPercentage: 0.8, // 棒の幅を調整
                        categoryPercentage: 0.8 // カテゴリ内の棒の幅を調整
                    });
                });

                charts.serviceSales = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: serviceLabels, // サービスタイプがラベルになる
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const storeLabel = context.dataset.label;
                                        const serviceLabel = context.label;
                                        const value = context.raw;
                                        return `${storeLabel} ${serviceLabel}: ¥${value.toLocaleString()}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: false, // スタックしない
                                title: {
                                    display: true,
                                    text: 'サービスタイプ'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '売上 (円)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '¥' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 店舗別総売上比較チャートの作成
            function createStoreSalesComparisonChart() {
                const ctx = document.getElementById('storeSalesComparisonChart').getContext('2d');
                
                const labels = fixedStores;
                const currentYearSales = [];

                fixedStores.forEach(store => {
                    const totalSalesCurrent = filteredData
                        .filter(item => item.storeName === store)
                        .reduce((sum, item) => sum + item.totalSales, 0);
                    currentYearSales.push(totalSalesCurrent);
                });

                charts.storeSalesComparison = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '総売上',
                                data: currentYearSales,
                                backgroundColor: chartColors.slice(0, fixedStores.length), // 店舗数に合わせて色を割り当て
                                borderColor: chartColors.slice(0, fixedStores.length).map(color => color.replace('1)', '0.8)')),
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // 単一データセットなので凡例は不要
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ¥${context.raw.toLocaleString()}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '店舗名'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '売上 (円)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '¥' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 店舗別利用者数比較チャートの作成
            function createStoreUserCountComparisonChart() {
                const ctx = document.getElementById('storeUserCountComparisonChart').getContext('2d');
                
                const labels = fixedStores;
                const currentYearSaunaCount = [];
                const currentYearStayingCount = [];

                fixedStores.forEach(store => {
                    const totalSaunaCurrent = filteredData
                        .filter(item => item.storeName === store)
                        .reduce((sum, item) => sum + item.saunaCount, 0);
                    currentYearSaunaCount.push(totalSaunaCurrent);

                    const totalStayingCurrent = filteredData
                        .filter(item => item.storeName === store)
                        .reduce((sum, item) => sum + item.stayingCount, 0);
                    currentYearStayingCount.push(totalStayingCurrent);
                });

                charts.storeUserCountComparison = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'サウナ利用者数',
                                data: currentYearSaunaCount,
                                backgroundColor: chartBackgroundColors[0],
                                borderColor: chartColors[0],
                                borderWidth: 1,
                                stack: 'users'
                            },
                            {
                                label: '宿泊利用者数',
                                data: currentYearStayingCount,
                                backgroundColor: chartBackgroundColors[2],
                                borderColor: chartColors[2],
                                borderWidth: 1,
                                stack: 'users'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw.toLocaleString()}人`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: '店舗名'
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '利用者数 (人)'
                                }
                            }
                        }
                    }
                });
            }

            // 共有モーダルの表示
            function showShareModal() {
                if (salesData.length === 0) {
                    alert('データを入力してから共有してください');
                    return;
                }
                
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const weekday = document.getElementById('weekdayFilter').value;
                
                // 現在のURLを取得
                const url = new URL(window.location.href);
                
                // パラメータをクリア
                url.search = '';
                
                // 新しいパラメータを設定
                url.searchParams.set('view', 'true');
                if (startDate) url.searchParams.set('start', startDate);
                if (endDate) url.searchParams.set('end', endDate);
                if (weekday !== 'all') url.searchParams.set('weekday', weekday);
                url.searchParams.set('stores', fixedStores.join(',')); // 固定店舗名を常に含める
                
                // データを圧縮して追加
                try {
                    // データを最適化（必要なフィールドのみ保持）
                    const optimizedData = salesData.map(item => ({
                        date: item.date,
                        weekday: item.weekday,
                        storeName: item.storeName, // 店舗名を追加
                        totalSales: item.totalSales,
                        saunaSales: item.saunaSales,
                        saunaCount: item.saunaCount,
                        stayingSales: item.stayingSales,
                        stayingCount: item.stayingCount,
                        massageSales: item.massageSales,
                        grillSales: item.grillSales,
                        retailSales: item.retailSales
                    }));
                    
                    const jsonData = JSON.stringify(optimizedData);
                    const compressedData = LZString.compressToEncodedURIComponent(jsonData);
                    url.searchParams.set('data', compressedData);
                    
                    // 共有URLを表示
                    document.getElementById('shareUrl').value = url.toString();
                    
                    // モーダルを表示
                    document.getElementById('shareModal').style.display = 'flex';
                } catch (e) {
                    console.error('データの圧縮に失敗しました:', e);
                    alert('データが大きすぎるため、共有URLの生成に失敗しました。データ量を減らしてお試しください。');
                }
            }

            // 共有モーダルの非表示
            function hideShareModal() {
                document.getElementById('shareModal').style.display = 'none';
            }

            // 共有URLのコピー
            function copyShareUrl() {
                const shareUrl = document.getElementById('shareUrl');
                shareUrl.select();
                document.execCommand('copy');
                
                const copyBtn = document.getElementById('copyUrlBtn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'コピーしました！';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            }

            // --- DOMContentLoaded内のイベントリスナー設定 ---
            document.getElementById('processDataBtn').addEventListener('click', processInputData);
            document.getElementById('loadSampleBtn').addEventListener('click', loadSampleData);
            document.getElementById('applyFilterBtn').addEventListener('click', applyFilters);
            document.getElementById('shareBtn').addEventListener('click', showShareModal);
            document.getElementById('closeModalBtn').addEventListener('click', hideShareModal);
            document.getElementById('copyUrlBtn').addEventListener('click', copyShareUrl);
            
            // URLパラメータをチェック
            checkUrlParams();
        });
    </script>
