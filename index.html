<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>施設売上分析ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
</head>
<body>
  <!-- ここに入力セクション、フィルター、チャート、テーブルなどUIが続きます（省略） -->

  <!-- 以下にJavaScript部分を全てまとめて記述 -->
  <script>
    // --- 変数と初期設定 ---
    let currentYearSalesData = [];
    let previousYearSalesData = [];
    let filteredCurrentYearData = [];
    let filteredPreviousYearData = [];
    let charts = {};
    let isViewMode = false;

    // --- 共有URLパラメータの読み取りと初期化 ---
    function checkUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const viewMode = urlParams.get('view');
      const startDate = urlParams.get('start');
      const endDate = urlParams.get('end');
      const weekday = urlParams.get('weekday');
      const compressedCurrentData = urlParams.get('current_data');
      const compressedPreviousData = urlParams.get('previous_data');

      if (viewMode === 'true') {
        isViewMode = true;
        document.getElementById('inputSection').style.display = 'none';

        if (startDate) document.getElementById('startDate').value = startDate;
        if (endDate) document.getElementById('endDate').value = endDate;
        if (weekday) document.getElementById('weekdayFilter').value = weekday;

        document.getElementById('shareBtn').textContent = 'データを編集';
        document.getElementById('shareBtn').addEventListener('click', () => location.href = location.pathname);

        if (compressedCurrentData) {
          try {
            const decompressedCurrentData = LZString.decompressFromEncodedURIComponent(compressedCurrentData);
            currentYearSalesData = JSON.parse(decompressedCurrentData || '[]');
          } catch (e) {
            alert('当期データの読み込みに失敗しました');
          }
        }

        if (compressedPreviousData) {
          try {
            const decompressedPreviousData = LZString.decompressFromEncodedURIComponent(compressedPreviousData);
            previousYearSalesData = JSON.parse(decompressedPreviousData || '[]');
          } catch (e) {
            alert('前年データの読み込みに失敗しました');
          }
        }

        if (currentYearSalesData.length > 0) {
          currentYearSalesData.sort((a, b) => a.date.localeCompare(b.date));
          previousYearSalesData.sort((a, b) => a.date.localeCompare(b.date));
          setupDateRange();
          applyFilters();
          document.getElementById('dashboardContent').classList.remove('hidden');
        }
      }
    }

    // --- チャート作成（5月1日対応） ---
    function createDailySalesChart() {
      const sortedCurrentData = [...filteredCurrentYearData].sort((a, b) => a.date.localeCompare(b.date));
      const sortedPreviousData = [...filteredPreviousYearData].sort((a, b) => a.date.localeCompare(b.date));

      const labels = sortedCurrentData.map(item => {
        const d = new Date(item.date);
        return `${d.getMonth() + 1}/${d.getDate()}`;
      });

      const baseYear = sortedCurrentData.length > 0 ? new Date(sortedCurrentData[0].date).getFullYear() : new Date().getFullYear();

      const totalSalesCurrent = sortedCurrentData.map(item => item.totalSales);
      const totalSalesPrevious = labels.map(label => {
        const [m, d] = label.split('/').map(Number);
        const prevDate = new Date(baseYear - 1, m - 1, d).toISOString().split('T')[0];
        const prev = sortedPreviousData.find(item => item.date === prevDate);
        return prev ? prev.totalSales : NaN;
      });

      const ctx = document.getElementById('dailySalesChart').getContext('2d');
      charts.dailySales = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: '総売上 (当期)', data: totalSalesCurrent, borderColor: 'blue', borderWidth: 2, fill: false },
            { label: '総売上 (前年)', data: totalSalesPrevious, borderColor: 'red', borderWidth: 2, borderDash: [5, 5], fill: false }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // --- 呼び出し ---
    document.addEventListener('DOMContentLoaded', checkUrlParams);
  </script>
</body>
</html>
