<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>施設売上分析ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <style>
        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background-color: #f0f4f8;
        }
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .chart-container-large {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .summary-card {
            background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
            color: white;
        }
        .summary-card-alt {
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
            color: white;
        }
        .weekday-0 { background-color: rgba(239, 68, 68, 0.1); }
        .weekday-6 { background-color: rgba(59, 130, 246, 0.1); }
        textarea {
            resize: none;
        }
        #shareModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-4 md:p-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">施設売上分析ダッシュボード</h1>
                <p class="text-gray-600 mt-2">日別データから自動生成されたインタラクティブな分析ツール</p>
            </div>
            <div id="dataInputSection">
                <button id="shareBtn" class="btn-primary px-4 py-2 rounded-md">分析結果を共有</button>
            </div>
        </header>

        <div class="mb-8" id="inputSection">
            <div class="card p-4 md:p-6">
                <h2 class="text-xl font-semibold mb-4">データを入力</h2>
                <p class="text-gray-600 mb-4">以下のテキストエリアにデータを貼り付けてください。<br>
                必要な列: 対象日, 曜日, 売上日計, サウナ, 人数（S), 宿泊売上計, 人数(C), マッサージ, グリ, 物販</p>
                
                <div class="flex flex-col gap-4">
                    <textarea id="dataInput" rows="6" class="w-full p-2 border border-gray-300 rounded-md" placeholder="ここにデータを貼り付けてください（CSVまたはタブ区切り形式）"></textarea>
                    
                    <div class="flex flex-col md:flex-row gap-4">
                        <button id="processDataBtn" class="btn-primary px-4 py-2 rounded-md">データを分析</button>
                        <button id="loadSampleBtn" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-md">サンプルデータを読み込む</button>
                    </div>
                </div>
                
                <div id="fileStatus" class="mt-4 hidden">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700" id="fileStatusText">
                                    データを処理中...
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboardContent" class="hidden">
            <div class="card p-4 md:p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">期間フィルター</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">期間</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="date" id="startDate" class="flex-1 p-2 border border-gray-300 rounded-md">
                            <span class="flex items-center justify-center">～</span>
                            <input type="date" id="endDate" class="flex-1 p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">曜日</label>
                        <select id="weekdayFilter" class="w-1/2 p-2 border border-gray-300 rounded-md">
                            <option value="all">すべて</option>
                            <option value="月">月曜日</option>
                            <option value="火">火曜日</option>
                            <option value="水">水曜日</option>
                            <option value="木">木曜日</option>
                            <option value="金">金曜日</option>
                            <option value="土">土曜日</option>
                            <option value="日">日曜日</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="applyFilterBtn" class="btn-primary px-4 py-2 rounded-md w-full">フィルターを適用</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="summary-card card p-4">
                    <h3 class="text-lg font-medium opacity-80">総売上</h3>
                    <p class="text-3xl font-bold mt-2" id="totalSales">¥0</p>
                    <p class="text-sm mt-1 opacity-80" id="salesCompare">期間合計</p>
                </div>
                <div class="summary-card-alt card p-4">
                    <h3 class="text-lg font-medium opacity-80">サウナ利用者数</h3>
                    <p class="text-3xl font-bold mt-2" id="totalSaunaCount">0人</p>
                    <p class="text-sm mt-1 opacity-80" id="saunaCountCompare">期間合計</p>
                </div>
                <div class="summary-card card p-4">
                    <h3 class="text-lg font-medium opacity-80">宿泊者数</h3>
                    <p class="text-3xl font-bold mt-2" id="totalStayingCount">0人</p>
                    <p class="text-sm mt-1 opacity-80" id="stayingCountCompare">期間合計</p>
                </div>
                <div class="summary-card-alt card p-4">
                    <h3 class="text-lg font-medium opacity-80">平均客単価</h3>
                    <p class="text-3xl font-bold mt-2" id="averagePrice">¥0</p>
                    <p class="text-sm mt-1 opacity-80" id="priceCompare">期間平均</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                <div class="card p-4 bg-blue-50">
                    <h3 class="text-md font-medium text-blue-800">サウナ売上</h3>
                    <p class="text-2xl font-bold mt-1 text-blue-900" id="saunaSalesTotal">¥0</p>
                    <p class="text-xs mt-1 text-blue-600" id="saunaSalesPercent">全体の0%</p>
                </div>
                <div class="card p-4 bg-indigo-50">
                    <h3 class="text-md font-medium text-indigo-800">宿泊売上</h3>
                    <p class="text-2xl font-bold mt-1 text-indigo-900" id="stayingSalesTotal">¥0</p>
                    <p class="text-xs mt-1 text-indigo-600" id="stayingSalesPercent">全体の0%</p>
                </div>
                <div class="card p-4 bg-purple-50">
                    <h3 class="text-md font-medium text-purple-800">マッサージ売上</h3>
                    <p class="text-2xl font-bold mt-1 text-purple-900" id="massageSalesTotal">¥0</p>
                    <p class="text-xs mt-1 text-purple-600" id="massageSalesPercent">全体の0%</p>
                </div>
                <div class="card p-4 bg-green-50">
                    <h3 class="text-md font-medium text-green-800">グリル売上</h3>
                    <p class="text-2xl font-bold mt-1 text-green-900" id="grillSalesTotal">¥0</p>
                    <p class="text-xs mt-1 text-green-600" id="grillSalesPercent">全体の0%</p>
                </div>
                <div class="card p-4 bg-amber-50">
                    <h3 class="text-md font-medium text-amber-800">物販売上</h3>
                    <p class="text-2xl font-bold mt-1 text-amber-900" id="retailSalesTotal">¥0</p>
                    <p class="text-xs mt-1 text-amber-600" id="retailSalesPercent">全体の0%</p>
                </div>
            </div>

            <div class="card p-4 md:p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">日別売上推移</h2>
                <div class="chart-container-large">
                    <canvas id="dailySalesChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="card p-4 md:p-6">
                    <h2 class="text-xl font-semibold mb-4">サービス別売上構成</h2>
                    <div class="chart-container">
                        <canvas id="serviceSalesChart"></canvas>
                    </div>
                </div>
                <div class="card p-4 md:p-6">
                    <h2 class="text-xl font-semibold mb-4">人数と売上の相関</h2>
                    <div class="chart-container">
                        <canvas id="correlationChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="card p-4 md:p-6">
                    <h2 class="text-xl font-semibold mb-4">曜日別サウナ利用分布</h2>
                    <div class="chart-container">
                        <canvas id="weekdaySaunaChart"></canvas>
                    </div>
                </div>
                <div class="card p-4 md:p-6">
                    <h2 class="text-xl font-semibold mb-4">曜日別宿泊利用分布</h2>
                    <div class="chart-container">
                        <canvas id="weekdayStayingChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card p-4 md:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">日別データ</h2>
                    <button id="exportCsvBtn" class="btn-primary px-4 py-2 rounded-md">CSVエクスポート</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日付</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">曜日</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">売上日計</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">サウナ売上</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">サウナ人数</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">宿泊売上</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">宿泊人数</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">マッサージ</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">グリル</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">物販</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <div class="text-sm text-gray-700" id="tableInfo">
                        0件中 1-0件を表示
                    </div>
                    <div class="flex gap-2">
                        <button id="prevPageBtn" class="px-3 py-1 border border-gray-300 rounded-md disabled:opacity-50">前へ</button>
                        <button id="nextPageBtn" class="px-3 py-1 border border-gray-300 rounded-md disabled:opacity-50">次へ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="shareModal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">分析結果を共有</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p class="mb-4">以下のURLを共有すると、現在の分析結果を他の人と共有できます。</p>
            <div class="flex mb-4">
                <input id="shareUrl" type="text" class="flex-1 p-2 border border-gray-300 rounded-l-md" readonly>
                <button id="copyUrlBtn" class="btn-primary px-4 py-2 rounded-r-md">コピー</button>
            </div>
            <div class="mt-4 text-sm text-gray-600">
                <p>※ 共有URLには入力データが含まれています。共有先でデータの入力は不要です。</p>
                <p>※ 長期間の保存には適していません。データ量が多い場合はURLが長くなります。</p>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let salesData = [];
        let filteredData = [];
        let currentPage = 1;
        const rowsPerPage = 10;
        let charts = {};
        let isViewMode = false;
        
        // 曜日の順序マッピング（ソート用）
        const weekdayOrder = {
            '月': 0,
            '火': 1,
            '水': 2,
            '木': 3,
            '金': 4,
            '土': 5,
            '日': 6
        };

        // DOMが読み込まれたら実行
        document.addEventListener('DOMContentLoaded', function() {
            // イベントリスナーの設定
            document.getElementById('processDataBtn').addEventListener('click', processInputData);
            document.getElementById('loadSampleBtn').addEventListener('click', loadSampleData);
            document.getElementById('applyFilterBtn').addEventListener('click', applyFilters);
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
            document.getElementById('prevPageBtn').addEventListener('click', () => changePage(-1));
            document.getElementById('nextPageBtn').addEventListener('click', () => changePage(1));
            document.getElementById('shareBtn').addEventListener('click', showShareModal);
            document.getElementById('closeModalBtn').addEventListener('click', hideShareModal);
            document.getElementById('copyUrlBtn').addEventListener('click', copyShareUrl);
            
            // URLパラメータをチェック
            checkUrlParams();
        });

        // URLパラメータのチェック
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const viewMode = urlParams.get('view');
            const startDate = urlParams.get('start');
            const endDate = urlParams.get('end');
            const weekday = urlParams.get('weekday');
            const compressedData = urlParams.get('data');
            
            if (viewMode === 'true') {
                isViewMode = true;
                // 入力セクションを非表示
                document.getElementById('inputSection').style.display = 'none';
                
                // フィルター設定を復元
                if (startDate) document.getElementById('startDate').value = startDate;
                if (endDate) document.getElementById('endDate').value = endDate;
                if (weekday) document.getElementById('weekdayFilter').value = weekday;
                
                // 共有ボタンのテキストを変更
                document.getElementById('shareBtn').textContent = 'データを編集';
                document.getElementById('shareBtn').removeEventListener('click', showShareModal); // 既存のイベントリスナーを削除
                document.getElementById('shareBtn').addEventListener('click', function() {
                    window.location.href = window.location.pathname; // 編集モードに戻る
                });
                
                // 圧縮データがある場合は復元
                if (compressedData) {
                    try {
                        const decompressedData = LZString.decompressFromEncodedURIComponent(compressedData);
                        if (decompressedData) {
                            const parsedData = JSON.parse(decompressedData);
                            if (Array.isArray(parsedData) && parsedData.length > 0) {
                                salesData = parsedData;
                                setupDateRange();
                                applyFilters();
                                document.getElementById('dashboardContent').classList.remove('hidden');
                            }
                        }
                    } catch (e) {
                        console.error('データの復元に失敗しました:', e);
                        alert('共有データの読み込みに失敗しました。URLが正しいか確認してください。');
                    }
                }
            }
        }

        // 入力データの処理
        function processInputData() {
            const inputText = document.getElementById('dataInput').value.trim();
            if (!inputText) {
                alert('データを入力してください');
                return;
            }

            const fileStatus = document.getElementById('fileStatus');
            const fileStatusText = document.getElementById('fileStatusText');
            
            fileStatus.classList.remove('hidden');
            fileStatusText.textContent = `データを処理中...`;

            try {
                // データの形式を判断（CSVかタブ区切りか）
                const delimiter = inputText.includes('\t') ? '\t' : ',';
                
                // データを行に分割
                const lines = inputText.split(/\r?\n/).filter(line => line.trim());
                
                // ヘッダー行を取得
                const headers = lines[0].split(delimiter).map(h => h.trim());
                
                // データ行を処理
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(delimiter);
                    if (values.length !== headers.length) continue;
                    
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index].trim();
                    });
                    data.push(row);
                }
                
                // データを処理
                processData(data);
                
            } catch (error) {
                fileStatusText.textContent = `エラー: ${error.message}`;
                console.error('データ処理エラー:', error);
            }
        }

        // サンプルデータの読み込み
        function loadSampleData() {
            const fileStatus = document.getElementById('fileStatus');
            const fileStatusText = document.getElementById('fileStatusText');
            
            fileStatus.classList.remove('hidden');
            fileStatusText.textContent = "サンプルデータを読み込み中...";

            // サンプルデータの生成
            const sampleData = generateSampleData();
            
            // 将来の日付を追加（2025/5/1）
            sampleData.push({
                date: "2025-05-01",
                weekday: "木",
                totalSales: 350000,
                saunaSales: 120000,
                saunaCount: 80,
                stayingSales: 150000,
                stayingCount: 25,
                massageSales: 40000,
                grillSales: 25000,
                retailSales: 15000
            });
            
            // サンプルデータをテキストエリアに表示
            const sampleText = formatSampleDataForDisplay(sampleData);
            document.getElementById('dataInput').value = sampleText;
            
            // サンプルデータは既に構造化されているので、直接処理
            salesData = sampleData;
            setupDateRange();
            applyFilters();
            
            // ダッシュボードを表示
            document.getElementById('dashboardContent').classList.remove('hidden');
            fileStatusText.textContent = `${salesData.length}件のサンプルデータを読み込みました。`;
        }

        // サンプルデータをテキストエリア表示用にフォーマット
        function formatSampleDataForDisplay(data) {
            if (!data || data.length === 0) return '';
            
            // ヘッダー行
            const headers = ['対象日', '曜日', '売上日計', 'サウナ', '人数（S)', '宿泊売上計', '人数(C)', 'マッサージ', 'グリ', '物販'];
            
            // データ行
            const rows = data.map(item => {
                // 日付をYYYY-MM-DD からYYYY/MM/DD に変換
                const formattedDate = item.date.replace(/-/g, '/');
                
                return [
                    formattedDate,
                    item.weekday,
                    item.totalSales,
                    item.saunaSales,
                    item.saunaCount,
                    item.stayingSales,
                    item.stayingCount,
                    item.massageSales,
                    item.grillSales,
                    item.retailSales
                ];
            });
            
            // タブ区切りで結合
            return [headers.join('\t')].concat(rows.map(row => row.join('\t'))).join('\n');
        }

        // サンプルデータの生成
        function generateSampleData() {
            const data = [];
            const weekdays = ['月', '火', '水', '木', '金', '土', '日'];
            
            // 過去3ヶ月分のデータを生成
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(endDate.getMonth() - 3);
            
            // 基本料金設定
            const baseSettings = {
                saunaPrice: 1500,
                stayingPrice: 6000,
                massagePrice: 4000,
                grillAvg: 1200,
                retailAvg: 800
            };
            
            // 曜日係数（土日は混む）
            const weekdayFactor = {
                '月': 0.7,
                '火': 0.6,
                '水': 0.7,
                '木': 0.8,
                '金': 1.0,
                '土': 1.5,
                '日': 1.3
            };

            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const weekday = weekdays[d.getDay() === 0 ? 6 : d.getDay() - 1]; // 0=日曜 を 6=日曜 に変換
                const factor = weekdayFactor[weekday];
                
                // 季節係数（月によって変動）
                const monthFactor = 1 + (Math.sin(d.getMonth() / 2) * 0.2);
                
                // ランダム係数（日によるばらつき）
                const randomFactor = 0.8 + (Math.random() * 0.4);
                
                // 総合係数
                const totalFactor = factor * monthFactor * randomFactor;
                
                // サウナ利用者数
                const saunaCount = Math.round(40 * totalFactor);
                
                // 宿泊者数（サウナ利用者の一部）
                const stayingCount = Math.round(saunaCount * 0.15);
                
                // 各売上の計算
                const saunaSales = saunaCount * baseSettings.saunaPrice;
                const stayingSales = stayingCount * baseSettings.stayingPrice;
                const massageSales = Math.round(saunaCount * 0.2) * baseSettings.massagePrice;
                const grillSales = Math.round(saunaCount * 0.6) * baseSettings.grillAvg;
                const retailSales = Math.round(saunaCount * 0.3) * baseSettings.retailAvg;
                
                // 総売上
                const totalSales = saunaSales + stayingSales + massageSales + grillSales + retailSales;
                
                data.push({
                    date: d.toISOString().split('T')[0],
                    weekday: weekday,
                    totalSales: Math.round(totalSales),
                    saunaSales: Math.round(saunaSales),
                    saunaCount: saunaCount,
                    stayingSales: Math.round(stayingSales),
                    stayingCount: stayingCount,
                    massageSales: Math.round(massageSales),
                    grillSales: Math.round(grillSales),
                    retailSales: Math.round(retailSales)
                });
            }

            return data;
        }

        // 日付文字列を標準形式（YYYY-MM-DD）に変換する関数
        function parseAndFormatDate(dateStr) {
            if (!dateStr) return null;
            
            // 日付文字列を正規化（区切り文字を統一）
            dateStr = String(dateStr).trim()
                .replace(/[年月]/g, '/')
                .replace(/日/g, '')
                .replace(/\s+/g, '');
            
            let parsedDate;
            
            // YYYY/MM/DD または YYYY-MM-DD 形式
            if (/^\d{4}[/-]\d{1,2}[/-]\d{1,2}$/.test(dateStr)) {
                const parts = dateStr.split(/[/-]/);
                parsedDate = new Date(parts[0], parts[1] - 1, parts[2]);
            }
            // MM/DD/YYYY 形式
            else if (/^\d{1,2}[/-]\d{1,2}[/-]\d{4}$/.test(dateStr)) {
                const parts = dateStr.split(/[/-]/);
                parsedDate = new Date(parts[2], parts[0] - 1, parts[1]);
            }
            // DD/MM/YYYY 形式（日本では少ないが一応）
            else if (/^\d{1,2}[/-]\d{1,2}[/-]\d{4}$/.test(dateStr)) {
                const parts = dateStr.split(/[/-]/);
                parsedDate = new Date(parts[2], parts[1] - 1, parts[0]);
            }
            // YYYYMMDD 形式
            else if (/^\d{8}$/.test(dateStr)) {
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                parsedDate = new Date(year, month - 1, day);
            }
            // その他の形式は直接 Date コンストラクタで試す
            else {
                parsedDate = new Date(dateStr);
            }
            
            // 日付が有効かチェック
            if (isNaN(parsedDate.getTime())) {
                console.warn(`無効な日付形式: ${dateStr}`);
                return null;
            }
            
            // YYYY-MM-DD 形式に変換
            const year = parsedDate.getFullYear();
            const month = String(parsedDate.getMonth() + 1).padStart(2, '0');
            const day = String(parsedDate.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        // データの処理
        function processData(data) {
            try {
                // データの前処理
                salesData = data.map(row => {
                    try {
                        // 日付の処理
                        let dateValue = row['対象日'] || row['日付'] || Object.values(row)[0];
                        const formattedDate = parseAndFormatDate(dateValue);
                        
                        if (!formattedDate) {
                            console.error("日付の解析に失敗:", dateValue);
                            return null;
                        }

                        // 数値の処理（カンマや通貨記号を除去）
                        const parseNumeric = (value) => {
                            if (value === undefined || value === null || value === '') return 0;
                            if (typeof value === 'number') return value;
                            return Number(String(value).replace(/[^\d.-]/g, '')) || 0;
                        };

                        // 各フィールドの取得（複数の可能性のある列名をチェック）
                        const weekday = row['曜日'] || '';
                        const totalSales = parseNumeric(row['売上日計'] || row['売上合計'] || row['総売上']);
                        const saunaSales = parseNumeric(row['サウナ'] || row['サウナ売上']);
                        
                        // サウナ人数 - 「人数（S)」または「サウナ人数」などの列を探す
                        let saunaCount = 0;
                        for (const key of Object.keys(row)) {
                            if (key.includes('人数') && (key.includes('S') || key.includes('s') || key.toLowerCase().includes('sauna'))) {
                                saunaCount = parseNumeric(row[key]);
                                break;
                            }
                        }
                        if (saunaCount === 0) {
                            saunaCount = parseNumeric(row['サウナ人数'] || row['サウナ利用者数']);
                        }
                        
                        const stayingSales = parseNumeric(row['宿泊売上計'] || row['宿泊売上'] || row['宿泊']);
                        
                        // 宿泊人数 - 「人数(C)」または「宿泊人数」などの列を探す
                        let stayingCount = 0;
                        for (const key of Object.keys(row)) {
                            if (key.includes('人数') && (key.includes('C') || key.includes('c') || key.toLowerCase().includes('stay'))) {
                                stayingCount = parseNumeric(row[key]);
                                break;
                            }
                        }
                        if (stayingCount === 0) {
                            stayingCount = parseNumeric(row['宿泊人数'] || row['宿泊者数']);
                        }
                        
                        const massageSales = parseNumeric(row['マッサージ'] || row['マッサージ売上']);
                        const grillSales = parseNumeric(row['グリ'] || row['グリル'] || row['グリル売上']);
                        const retailSales = parseNumeric(row['物販'] || row['物販売上']);

                        return {
                            date: formattedDate,
                            weekday: weekday,
                            totalSales: totalSales,
                            saunaSales: saunaSales,
                            saunaCount: saunaCount,
                            stayingSales: stayingSales,
                            stayingCount: stayingCount,
                            massageSales: massageSales,
                            grillSales: grillSales,
                            retailSales: retailSales
                        };
                    } catch (innerError) {
                        console.error('個別の行の処理中にエラーが発生しました:', row, innerError);
                        return null; // エラーが発生した行はスキップ
                    }
                }).filter(row => row !== null); // nullをフィルタリングして削除

                if (salesData.length === 0) {
                    throw new Error('有効なデータが検出されませんでした。列名とデータ形式を確認してください。');
                }

                // 日付でソート
                salesData.sort((a, b) => new Date(a.date) - new Date(b.date));

                // 日付フィルターの初期設定
                setupDateRange();
                // フィルターを適用してダッシュボードを更新
                applyFilters();

                document.getElementById('dashboardContent').classList.remove('hidden');
                document.getElementById('fileStatusText').textContent = `${salesData.length}件のデータを正常に処理しました。`;

            } catch (error) {
                document.getElementById('fileStatusText').textContent = `データの処理中にエラーが発生しました: ${error.message}`;
                document.getElementById('dashboardContent').classList.add('hidden');
                console.error('データの処理中にエラー:', error);
                alert(`データの処理に失敗しました。詳細: ${error.message}\n\n入力データが正しい形式（CSVまたはタブ区切り）であり、必要な列（対象日, 曜日, 売上日計, サウナ, 人数（S), 宿泊売上計, 人数(C), マッサージ, グリ, 物販）が含まれているか確認してください。`);
            }
        }

        // 日付範囲セレクターの初期設定
        function setupDateRange() {
            if (salesData.length > 0) {
                const firstDate = salesData[0].date;
                const lastDate = salesData[salesData.length - 1].date;
                document.getElementById('startDate').value = firstDate;
                document.getElementById('endDate').value = lastDate;
            } else {
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
            }
        }

        // フィルターを適用して表示を更新
        function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const selectedWeekday = document.getElementById('weekdayFilter').value;

            filteredData = salesData.filter(row => {
                const rowDate = row.date;
                const dateInRange = (!startDate || rowDate >= startDate) && (!endDate || rowDate <= endDate);
                const weekdayMatches = (selectedWeekday === 'all' || row.weekday === selectedWeekday);
                return dateInRange && weekdayMatches;
            });

            // ダッシュボードを更新
            updateSummaryCards();
            updateServiceSalesSummary();
            drawCharts();
            currentPage = 1; // フィルター適用時は1ページ目に戻る
            renderTable();
        }

        // サマリーカードの更新
        function updateSummaryCards() {
            const totalSales = filteredData.reduce((sum, row) => sum + row.totalSales, 0);
            const totalSaunaCount = filteredData.reduce((sum, row) => sum + row.saunaCount, 0);
            const totalStayingCount = filteredData.reduce((sum, row) => sum + row.stayingCount, 0);
            const totalAttendees = totalSaunaCount + totalStayingCount; // サウナ利用者と宿泊者の合計
            const averagePrice = totalAttendees > 0 ? totalSales / totalAttendees : 0;

            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('totalSaunaCount').textContent = `${totalSaunaCount}人`;
            document.getElementById('totalStayingCount').textContent = `${totalStayingCount}人`;
            document.getElementById('averagePrice').textContent = formatCurrency(averagePrice);
        }

        // サービス別サマリーの更新
        function updateServiceSalesSummary() {
            const totalSales = filteredData.reduce((sum, row) => sum + row.totalSales, 0);
            const saunaSales = filteredData.reduce((sum, row) => sum + row.saunaSales, 0);
            const stayingSales = filteredData.reduce((sum, row) => sum + row.stayingSales, 0);
            const massageSales = filteredData.reduce((sum, row) => sum + row.massageSales, 0);
            const grillSales = filteredData.reduce((sum, row) => sum + row.grillSales, 0);
            const retailSales = filteredData.reduce((sum, row) => sum + row.retailSales, 0);

            document.getElementById('saunaSalesTotal').textContent = formatCurrency(saunaSales);
            document.getElementById('stayingSalesTotal').textContent = formatCurrency(stayingSales);
            document.getElementById('massageSalesTotal').textContent = formatCurrency(massageSales);
            document.getElementById('grillSalesTotal').textContent = formatCurrency(grillSales);
            document.getElementById('retailSalesTotal').textContent = formatCurrency(retailSales);

            const calculatePercentage = (value, total) => total > 0 ? `${((value / total) * 100).toFixed(1)}%` : '0%';

            document.getElementById('saunaSalesPercent').textContent = `全体の${calculatePercentage(saunaSales, totalSales)}`;
            document.getElementById('stayingSalesPercent').textContent = `全体の${calculatePercentage(stayingSales, totalSales)}`;
            document.getElementById('massageSalesPercent').textContent = `全体の${calculatePercentage(massageSales, totalSales)}`;
            document.getElementById('grillSalesPercent').textContent = `全体の${calculatePercentage(grillSales, totalSales)}`;
            document.getElementById('retailSalesPercent').textContent = `全体の${calculatePercentage(retailSales, totalSales)}`;
        }

        // 全てのチャートを描画または更新
        function drawCharts() {
            // 既存のチャートがあれば破棄
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            drawDailySalesChart();
            drawServiceSalesChart();
            drawCorrelationChart();
            drawWeekdaySaunaChart();
            drawWeekdayStayingChart();
        }

        // 日別売上推移チャート
        function drawDailySalesChart() {
            const ctx = document.getElementById('dailySalesChart').getContext('2d');
            const dates = filteredData.map(row => row.date);
            const totalSales = filteredData.map(row => row.totalSales);
            const saunaSales = filteredData.map(row => row.saunaSales);
            const stayingSales = filteredData.map(row => row.stayingSales);

            charts.dailySalesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '売上日計',
                        data: totalSales,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }, {
                        label: 'サウナ売上',
                        data: saunaSales,
                        borderColor: 'rgb(54, 162, 235)',
                        tension: 0.1,
                        fill: false
                    }, {
                        label: '宿泊売上',
                        data: stayingSales,
                        borderColor: 'rgb(153, 102, 255)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '日別売上推移'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'YYYY/MM/DD',
                                displayFormats: {
                                    day: 'MM/DD'
                                }
                            },
                            title: {
                                display: true,
                                text: '日付'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '売上 (¥)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // サービス別売上構成チャート
        function drawServiceSalesChart() {
            const ctx = document.getElementById('serviceSalesChart').getContext('2d');
            const saunaSales = filteredData.reduce((sum, row) => sum + row.saunaSales, 0);
            const stayingSales = filteredData.reduce((sum, row) => sum + row.stayingSales, 0);
            const massageSales = filteredData.reduce((sum, row) => sum + row.massageSales, 0);
            const grillSales = filteredData.reduce((sum, row) => sum + row.grillSales, 0);
            const retailSales = filteredData.reduce((sum, row) => sum + row.retailSales, 0);

            const data = {
                labels: ['サウナ', '宿泊', 'マッサージ', 'グリル', '物販'],
                datasets: [{
                    data: [saunaSales, stayingSales, massageSales, grillSales, retailSales],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(153, 102, 255, 0.6)',
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(255, 206, 86, 0.6)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    borderWidth: 1
                }]
            };

            charts.serviceSalesChart = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'サービス別売上構成'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                    return `${label}: ¥${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 人数と売上の相関チャート
        function drawCorrelationChart() {
            const ctx = document.getElementById('correlationChart').getContext('2d');
            const dataPoints = filteredData.map(row => ({
                x: row.saunaCount + row.stayingCount, // 総人数
                y: row.totalSales // 総売上
            }));

            charts.correlationChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: '総人数 vs 総売上',
                        data: dataPoints,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '総人数と総売上の相関'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.parsed;
                                    return `人数: ${point.x}人, 売上: ¥${point.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '総人数 (人)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '総売上 (¥)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // 曜日別サウナ利用分布チャート
        function drawWeekdaySaunaChart() {
            const ctx = document.getElementById('weekdaySaunaChart').getContext('2d');
            const weekdaySales = {};
            const weekdaysOrder = ['月', '火', '水', '木', '金', '土', '日']; // 曜日の順序

            filteredData.forEach(row => {
                weekdaySales[row.weekday] = (weekdaySales[row.weekday] || 0) + row.saunaCount;
            });

            const labels = weekdaysOrder.filter(day => weekdaySales[day] !== undefined);
            const data = labels.map(day => weekdaySales[day]);

            charts.weekdaySaunaChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'サウナ利用者数',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '曜日別サウナ利用者数'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '曜日'
                            },
                            // 曜日順にソートするための設定
                            ticks: {
                                callback: function(val, index) {
                                    return labels[index];
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '利用者数 (人)'
                            }
                        }
                    }
                }
            });
        }

        // 曜日別宿泊利用分布チャート
        function drawWeekdayStayingChart() {
            const ctx = document.getElementById('weekdayStayingChart').getContext('2d');
            const weekdaySales = {};
            const weekdaysOrder = ['月', '火', '水', '木', '金', '土', '日']; // 曜日の順序

            filteredData.forEach(row => {
                weekdaySales[row.weekday] = (weekdaySales[row.weekday] || 0) + row.stayingCount;
            });

            const labels = weekdaysOrder.filter(day => weekdaySales[day] !== undefined);
            const data = labels.map(day => weekdaySales[day]);

            charts.weekdayStayingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '宿泊者数',
                        data: data,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '曜日別宿泊者数'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '曜日'
                            },
                            // 曜日順にソートするための設定
                            ticks: {
                                callback: function(val, index) {
                                    return labels[index];
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '宿泊者数 (人)'
                            }
                        }
                    }
                }
            });
        }

        // データテーブルのレンダリング
        function renderTable() {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = ''; // 既存の行をクリア

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
            const paginatedData = filteredData.slice(startIndex, endIndex);

            paginatedData.forEach(row => {
                const tr = document.createElement('tr');
                const dateObj = new Date(row.date);
                const dayOfWeek = dateObj.getDay(); // 0: 日曜日, 1: 月曜日, ..., 6: 土曜日
                
                // 曜日に応じて背景色を設定
                if (dayOfWeek === 0) { // 日曜日
                    tr.classList.add('weekday-0');
                } else if (dayOfWeek === 6) { // 土曜日
                    tr.classList.add('weekday-6');
                }

                tr.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${row.date}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${row.weekday}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right">${formatCurrency(row.totalSales)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right">${formatCurrency(row.saunaSales)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right">${row.saunaCount.toLocaleString()}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right">${formatCurrency(row.stayingSales)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right">${row.stayingCount.toLocaleString()}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right">${formatCurrency(row.massageSales)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right">${formatCurrency(row.grillSales)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right">${formatCurrency(row.retailSales)}</td>
                `;
                tableBody.appendChild(tr);
            });

            // ページネーションコントロールの更新
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages || filteredData.length === 0;
            document.getElementById('tableInfo').textContent = `${filteredData.length}件中 ${startIndex + 1}-${endIndex}件を表示`;
        }

        // ページ変更
        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            currentPage += direction;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
            renderTable();
        }

        // 数値を通貨形式にフォーマット
        function formatCurrency(amount) {
            return `¥${Math.round(amount).toLocaleString()}`;
        }

        // CSVエクスポート
        function exportToCsv() {
            if (filteredData.length === 0) {
                alert('エクスポートするデータがありません。');
                return;
            }

            const headers = ['日付', '曜日', '売上日計', 'サウナ売上', 'サウナ人数', '宿泊売上', '宿泊人数', 'マッサージ', 'グリル', '物販'];
            const rows = filteredData.map(row => [
                row.date,
                row.weekday,
                row.totalSales,
                row.saunaSales,
                row.saunaCount,
                row.stayingSales,
                row.stayingCount,
                row.massageSales,
                row.grillSales,
                row.retailSales
            ]);

            let csvContent = "data:text/csv;charset=utf-8," 
                + headers.join(",") + "\n" 
                + rows.map(e => e.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "sales_analysis_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 共有モーダルを表示
        function showShareModal() {
            const modal = document.getElementById('shareModal');
            modal.style.display = 'flex';

            const currentUrl = new URL(window.location.origin + window.location.pathname);
            currentUrl.searchParams.set('view', 'true');
            currentUrl.searchParams.set('start', document.getElementById('startDate').value);
            currentUrl.searchParams.set('end', document.getElementById('endDate').value);
            currentUrl.searchParams.set('weekday', document.getElementById('weekdayFilter').value);
            
            // フィルタリングされたデータを圧縮してURLに追加
            const dataToShare = JSON.stringify(salesData); // 元データ全体を共有
            const compressedData = LZString.compressToEncodedURIComponent(dataToShare);
            currentUrl.searchParams.set('data', compressedData);

            document.getElementById('shareUrl').value = currentUrl.toString();
        }

        // 共有モーダルを非表示
        function hideShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }

        // 共有URLをクリップボードにコピー
        function copyShareUrl() {
            const shareUrlInput = document.getElementById('shareUrl');
            shareUrlInput.select();
            document.execCommand('copy');
            alert('URLがクリップボードにコピーされました！');
        }

    </script>
</body>
</html>
